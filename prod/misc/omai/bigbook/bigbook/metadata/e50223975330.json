{
  "id": "e50223975330",
  "originalPath": "/var/www/orthodox-church-mgmt/orthodoxmetrics/prod/server/database/migrate-ocr-database.sh",
  "relativePath": "server/database/migrate-ocr-database.sh",
  "name": "migrate-ocr-database.sh",
  "extension": ".sh",
  "size": 3615,
  "modified": "2025-07-24T14:51:40.504Z",
  "created": "2025-07-24T14:51:40.504Z",
  "classification": {
    "type": "Database Scripts",
    "category": "Backend > Database",
    "confidence": 4
  },
  "metadata": {
    "fileStats": {
      "lines": 114,
      "characters": 3575,
      "words": 492
    },
    "classification": {
      "type": "Database Scripts",
      "category": "Backend > Database",
      "confidence": 4
    },
    "dependencies": [],
    "security": {
      "findings": [
        {
          "type": "sensitive_data",
          "pattern": "(?:password|pwd|pass)\\s*[:=]\\s*['\"]([^'\"]+)['\"]",
          "line": 12,
          "redacted": true
        }
      ],
      "hasSecurityIssues": true,
      "redactedContent": "#!/bin/bash\n# OCR Database Migration Script\n# Migrates OCR configuration schema and data from saints_peter_and_paul_orthodox_church_db to orthodoxmetrics_ocr_db\n\nset -e  # Exit on any error\n\necho \"ğŸš€ Starting OCR Database Migration...\"\necho \"======================================\"\n\n# Database credentials\nDB_USER=\"orthodoxapps\"\nDB_PASS=\"[REDACTED]\"\nOLD_DB=\"saints_peter_and_paul_orthodox_church_db\"\nNEW_DB=\"orthodoxmetrics_ocr_db\"\n\necho \"ğŸ“‹ Migration Details:\"\necho \"  Source DB: ${OLD_DB}\"\necho \"  Target DB: ${NEW_DB}\"\necho \"  Tables: ocr_settings, ocr_jobs, ocr_queue\"\necho \"\"\n\n# Step 1: Create the new target database\necho \"ğŸ”§ Step 1: Creating new OCR database...\"\nmysql -u $DB_USER -p$DB_PASS -e \"CREATE DATABASE IF NOT EXISTS ${NEW_DB};\"\necho \"âœ… Database ${NEW_DB} created successfully\"\n\n# Step 2: Dump OCR tables from the old database\necho \"ğŸ”§ Step 2: Dumping OCR tables from source database...\"\nmysqldump -u $DB_USER -p$DB_PASS $OLD_DB \\\n  ocr_settings ocr_jobs ocr_queue \\\n  --routines --triggers --single-transaction \\\n  > ocr_migration_dump.sql\n\nif [ $? -eq 0 ]; then\n    echo \"âœ… OCR tables dumped successfully to ocr_migration_dump.sql\"\nelse\n    echo \"âŒ Error: Failed to dump OCR tables\"\n    exit 1\nfi\n\n# Step 3: Import the dump into the new OCR database\necho \"ğŸ”§ Step 3: Importing OCR tables into new database...\"\nmysql -u $DB_USER -p$DB_PASS $NEW_DB < ocr_migration_dump.sql\n\nif [ $? -eq 0 ]; then\n    echo \"âœ… OCR tables imported successfully into ${NEW_DB}\"\nelse\n    echo \"âŒ Error: Failed to import OCR tables\"\n    exit 1\nfi\n\n# Step 4: Verify the migration\necho \"ğŸ”§ Step 4: Verifying migration...\"\necho \"Checking table counts:\"\n\nfor table in ocr_settings ocr_jobs ocr_queue; do\n    OLD_COUNT=$(mysql -u $DB_USER -p$DB_PASS -s -N -e \"SELECT COUNT(*) FROM ${OLD_DB}.${table}\")\n    NEW_COUNT=$(mysql -u $DB_USER -p$DB_PASS -s -N -e \"SELECT COUNT(*) FROM ${NEW_DB}.${table}\")\n    echo \"  ${table}: ${OLD_COUNT} â†’ ${NEW_COUNT}\"\n    \n    if [ \"$OLD_COUNT\" -eq \"$NEW_COUNT\" ]; then\n        echo \"    âœ… Migration verified for ${table}\"\n    else\n        echo \"    âŒ Warning: Row count mismatch for ${table}\"\n    fi\ndone\n\n# Step 5: Create indexes and optimize tables\necho \"ğŸ”§ Step 5: Optimizing new database...\"\nmysql -u $DB_USER -p$DB_PASS $NEW_DB << 'EOF'\n-- Ensure all indexes are present\nALTER TABLE ocr_jobs \n  ADD INDEX IF NOT EXISTS idx_church_status (church_id, status),\n  ADD INDEX IF NOT EXISTS idx_record_type (record_type),\n  ADD INDEX IF NOT EXISTS idx_created_at (created_at);\n\nALTER TABLE ocr_queue \n  ADD INDEX IF NOT EXISTS idx_church_status (church_id, status),\n  ADD INDEX IF NOT EXISTS idx_priority (priority, scheduled_at);\n\nALTER TABLE ocr_settings \n  ADD UNIQUE INDEX IF NOT EXISTS unique_church_id (church_id);\n\n-- Optimize tables\nOPTIMIZE TABLE ocr_settings, ocr_jobs, ocr_queue;\nEOF\n\necho \"âœ… Database optimization complete\"\n\n# Step 6: Display summary\necho \"\"\necho \"ğŸ“Š Migration Summary:\"\necho \"====================\"\nmysql -u $DB_USER -p$DB_PASS $NEW_DB -e \"\nSELECT \n  TABLE_NAME as 'Table',\n  TABLE_ROWS as 'Rows',\n  ROUND(((DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024), 2) as 'Size (MB)'\nFROM information_schema.TABLES \nWHERE TABLE_SCHEMA = '${NEW_DB}' \nAND TABLE_NAME LIKE 'ocr_%'\nORDER BY TABLE_NAME;\n\"\n\necho \"\"\necho \"ğŸ‰ OCR Database Migration Complete!\"\necho \"Next steps:\"\necho \"  1. Update .env files to use OCR_DATABASE=${NEW_DB}\"\necho \"  2. Update application code references\"\necho \"  3. Test OCR functionality\"\necho \"  4. [Optional] Drop old OCR tables after testing\"\necho \"\"\necho \"âš ï¸  Remember to backup before making any changes!\"\n"
    },
    "complexity": {
      "totalLines": 114,
      "codeLines": 84,
      "commentLines": 10,
      "commentRatio": 0.10638297872340426,
      "averageLineLength": 36.787234042553195
    },
    "lastAnalyzed": "2025-07-28T07:20:00.017Z"
  },
  "contentHash": "a6b695c47c6b8ed548670e41c59b7432e5719eb72271adf0c5f400e10a56c405",
  "discoveredAt": "2025-07-28T07:20:00.017Z"
}