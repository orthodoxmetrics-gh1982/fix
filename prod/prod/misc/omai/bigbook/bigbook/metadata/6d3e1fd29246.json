{
  "id": "6d3e1fd29246",
  "originalPath": "/var/www/orthodox-church-mgmt/orthodoxmetrics/prod/server/database/migrate_ocr_database.sh",
  "relativePath": "server/database/migrate_ocr_database.sh",
  "name": "migrate_ocr_database.sh",
  "extension": ".sh",
  "size": 4194,
  "modified": "2025-07-24T14:51:40.504Z",
  "created": "2025-07-24T14:51:40.504Z",
  "classification": {
    "type": "Database Scripts",
    "category": "Backend > Database",
    "confidence": 3
  },
  "metadata": {
    "fileStats": {
      "lines": 130,
      "characters": 4128,
      "words": 521
    },
    "classification": {
      "type": "Database Scripts",
      "category": "Backend > Database",
      "confidence": 3
    },
    "dependencies": [],
    "security": {
      "findings": [
        {
          "type": "sensitive_data",
          "pattern": "(?:password|pwd|pass)\\s*[:=]\\s*['\"]([^'\"]+)['\"]",
          "line": 13,
          "redacted": true
        }
      ],
      "hasSecurityIssues": true,
      "redactedContent": "#!/bin/bash\n\n# OCR Database Migration Script\n# Migrates OCR configuration and data from saints_peter_and_paul_orthodox_church_db to orthodoxmetrics_ocr_db\n# Date: July 19, 2025\n\nset -e  # Exit on any error\n\n# Configuration\nOLD_DB=\"saints_peter_and_paul_orthodox_church_db\"\nNEW_DB=\"orthodoxmetrics_ocr_db\"\nMYSQL_USER=\"orthodoxapps\"\nMYSQL_PASSWORD=\"[REDACTED]\"\nBACKUP_DIR=\"./database/ocr_migration_backup\"\nTIMESTAMP=$(date +\"%Y%m%d_%H%M%S\")\n\necho \"üöÄ Starting OCR Database Migration\"\necho \"üìÖ Timestamp: $TIMESTAMP\"\necho \"üîÑ Migrating from: $OLD_DB\"\necho \"üéØ Migrating to: $NEW_DB\"\necho \"\"\n\n# Create backup directory\nmkdir -p \"$BACKUP_DIR\"\n\necho \"üì¶ Step 1: Creating backup of existing OCR tables...\"\nmysqldump -u \"$MYSQL_USER\" -p\"$MYSQL_PASSWORD\" \\\n  --single-transaction \\\n  --routines \\\n  --triggers \\\n  \"$OLD_DB\" \\\n  ocr_settings ocr_jobs ocr_queue \\\n  > \"$BACKUP_DIR/ocr_backup_$TIMESTAMP.sql\"\n\nif [ $? -eq 0 ]; then\n    echo \"‚úÖ Backup created successfully: $BACKUP_DIR/ocr_backup_$TIMESTAMP.sql\"\nelse\n    echo \"‚ùå Backup failed! Aborting migration.\"\n    exit 1\nfi\n\necho \"\"\necho \"üèóÔ∏è Step 2: Creating new OCR database...\"\nmysql -u \"$MYSQL_USER\" -p\"$MYSQL_PASSWORD\" -e \"\nCREATE DATABASE IF NOT EXISTS \\`$NEW_DB\\` \nCHARACTER SET utf8mb4 \nCOLLATE utf8mb4_unicode_ci;\n\"\n\nif [ $? -eq 0 ]; then\n    echo \"‚úÖ Database $NEW_DB created successfully\"\nelse\n    echo \"‚ùå Failed to create database $NEW_DB\"\n    exit 1\nfi\n\necho \"\"\necho \"üìã Step 3: Importing OCR tables into new database...\"\nmysql -u \"$MYSQL_USER\" -p\"$MYSQL_PASSWORD\" \"$NEW_DB\" < \"$BACKUP_DIR/ocr_backup_$TIMESTAMP.sql\"\n\nif [ $? -eq 0 ]; then\n    echo \"‚úÖ OCR tables imported successfully\"\nelse\n    echo \"‚ùå Failed to import OCR tables\"\n    exit 1\nfi\n\necho \"\"\necho \"üîç Step 4: Verifying migration...\"\necho \"Checking table counts:\"\n\n# Check table counts\nfor table in ocr_settings ocr_jobs ocr_queue; do\n    OLD_COUNT=$(mysql -u \"$MYSQL_USER\" -p\"$MYSQL_PASSWORD\" -sN -e \"SELECT COUNT(*) FROM $OLD_DB.$table;\" 2>/dev/null || echo \"0\")\n    NEW_COUNT=$(mysql -u \"$MYSQL_USER\" -p\"$MYSQL_PASSWORD\" -sN -e \"SELECT COUNT(*) FROM $NEW_DB.$table;\" 2>/dev/null || echo \"0\")\n    \n    echo \"  üìä $table: $OLD_COUNT ‚Üí $NEW_COUNT records\"\n    \n    if [ \"$OLD_COUNT\" != \"$NEW_COUNT\" ]; then\n        echo \"‚ö†Ô∏è  Warning: Record count mismatch for $table\"\n    fi\ndone\n\necho \"\"\necho \"üîê Step 5: Configuring OCR database permissions for orthodoxapps user...\"\nmysql -u \"$MYSQL_USER\" -p\"$MYSQL_PASSWORD\" -e \"\n-- Grant permissions on the new OCR database to existing orthodoxapps user\nGRANT SELECT, INSERT, UPDATE, DELETE ON \\`$NEW_DB\\`.* TO 'orthodoxapps'@'localhost';\n\n-- Grant permissions on the records database for church info\nGRANT SELECT ON \\`ssppoc_records_db\\`.* TO 'orthodoxapps'@'localhost';\n\n-- Flush privileges\nFLUSH PRIVILEGES;\n\"\n\necho \"‚úÖ OCR permissions configured for orthodoxapps user\"\n\necho \"\"\necho \"üìù Step 6: Creating additional indexes for performance...\"\nmysql -u \"$MYSQL_USER\" -p\"$MYSQL_PASSWORD\" \"$NEW_DB\" -e \"\n-- Add performance indexes if they don't exist\nCREATE INDEX IF NOT EXISTS idx_ocr_jobs_status_created ON ocr_jobs(status, created_at);\nCREATE INDEX IF NOT EXISTS idx_ocr_jobs_church_record_type ON ocr_jobs(church_id, record_type);\nCREATE INDEX IF NOT EXISTS idx_ocr_queue_status_priority ON ocr_queue(status, priority, scheduled_at);\nCREATE INDEX IF NOT EXISTS idx_ocr_settings_church ON ocr_settings(church_id);\n\"\n\necho \"‚úÖ Performance indexes created\"\n\necho \"\"\necho \"üéâ Migration completed successfully!\"\necho \"\"\necho \"üìã Summary:\"\necho \"  üóÇÔ∏è  Backup saved to: $BACKUP_DIR/ocr_backup_$TIMESTAMP.sql\"\necho \"  üÜï New database: $NEW_DB\"\necho \"  üë§ Database user: orthodoxapps@localhost\"\necho \"  üîó Connection string: mysql://orthodoxapps@localhost/$NEW_DB\"\necho \"\"\necho \"üîß Next steps:\"\necho \"  1. Update application configuration files\"\necho \"  2. Update database connection strings in code\"\necho \"  3. Test OCR functionality\"\necho \"  4. Remove old OCR tables after verification (optional)\"\necho \"\"\necho \"‚ö†Ô∏è  Remember to update your .env files:\"\necho \"     OCR_DATABASE=$NEW_DB\"\necho \"     OCR_DB_USER=orthodoxapps\"\necho \"     OCR_DB_PASSWORD=OCR_SecurePass_2025!\"\n"
    },
    "complexity": {
      "totalLines": 130,
      "codeLines": 100,
      "commentLines": 7,
      "commentRatio": 0.06542056074766354,
      "averageLineLength": 37.299065420560744
    },
    "lastAnalyzed": "2025-07-28T07:20:00.019Z"
  },
  "contentHash": "9ff58733ae7f58da15f4e9c0f32853150424f2a03ae9eb49b29e418b668a6c96",
  "discoveredAt": "2025-07-28T07:20:00.019Z"
}