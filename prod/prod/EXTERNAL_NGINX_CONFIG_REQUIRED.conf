# External Nginx Configuration Required for orthodoxmetrics.com
# Add these configurations to the external nginx server that proxies to the internal server

# 1. WebSocket Support for OMAI Logger
location /ws/omai-logger {
    proxy_pass http://INTERNAL_SERVER_IP:3001/ws/omai-logger;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # WebSocket specific timeouts
    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    proxy_read_timeout 7d;
}

# 2. WebSocket Support for JIT Terminal (if used)
location /api/jit/ws {
    proxy_pass http://INTERNAL_SERVER_IP:3001/api/jit/ws;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    proxy_read_timeout 7d;
}

# 3. Build Metadata File - Direct proxy to backend
location = /build.meta.json {
    proxy_pass http://INTERNAL_SERVER_IP:3001/build.meta.json;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Disable caching for build metadata
    proxy_cache_bypass 1;
    proxy_no_cache 1;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
}

# 4. API Proxy (ensure this exists)
location /api/ {
    proxy_pass http://INTERNAL_SERVER_IP:3001/api/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Support for large uploads
    client_max_body_size 100M;
    
    # Timeouts for long-running requests
    proxy_connect_timeout 600;
    proxy_send_timeout 600;
    proxy_read_timeout 600;
}

# 5. Socket.IO Support (if using Socket.IO for other features)
location /socket.io/ {
    proxy_pass http://INTERNAL_SERVER_IP:3001/socket.io/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Note: Based on hostname -I, your internal server IP appears to be 192.168.1.239
# Update all INTERNAL_SERVER_IP references to: 192.168.1.239
# 
# Example: proxy_pass http://192.168.1.239:3001/ws/omai-logger;
